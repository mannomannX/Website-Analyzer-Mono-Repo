name: 'Fusion-Repo Sync'
on:
  workflow_dispatch:
  repository_dispatch:
    types: [monomono-sync-event]
jobs:
  sync-repos:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout fusion repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.ACCESS_TOKEN }}
      - name: Sync and Rebuild
        run: |
          REPOS_TO_SYNC='mannomannX/website-analyzer-dashboard,mannomannX/website-analyzer-api'
          echo "-> Pruning obsolete directories..."
          ALL_DIRS=$(find . -maxdepth 1 -mindepth 1 -type d ! -name '.git' -exec basename {} \;)
          for dir in $ALL_DIRS; do
            is_in_sync_list=false
            for repo_in_list in $(echo "$REPOS_TO_SYNC" | sed "s/,/ /g"); do
              if [ "$(basename "$repo_in_list")" == "$dir" ]; then
                is_in_sync_list=true; break;
              fi
            done
            if [ "$is_in_sync_list" == "false" ]; then
              echo "   - Deleting obsolete directory: $dir"; rm -rf "$dir";
            fi
          done
          echo "-> Cloning sub-repos..."
          for repo in $(echo "$REPOS_TO_SYNC" | sed "s/,/ /g"); do
            folder_name=$(basename $repo)
            rm -rf "$folder_name"
            git clone --depth 1 "https://x-access-token:${{ secrets.ACCESS_TOKEN }}@github.com/$repo.git" "$folder_name" --quiet && rm -rf "$folder_name/.git"
          done